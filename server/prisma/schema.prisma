generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String     @id @default(cuid())
  email        String     @unique
  username     String     @unique
  password     String
  avatar       String?
  refreshToken String?
  status       UserStatus @default(OFFLINE)
  lastSeen     DateTime   @default(now())
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  sentMessages     Message[]      @relation("MessageSender")
  roomMemberships  RoomMember[]
  createdRooms     Room[]         @relation("RoomCreator")
  notifications    Notification[]

  @@map("users")
}

model Room {
  id          String   @id @default(cuid())
  name        String
  description String?
  type        RoomType @default(GROUP)
  isPrivate   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  creator   User         @relation("RoomCreator", fields: [creatorId], references: [id])
  creatorId String
  members   RoomMember[]
  messages  Message[]

  @@map("rooms")
}

model RoomMember {
  id       String     @id @default(cuid())
  role     MemberRole @default(MEMBER)
  joinedAt DateTime   @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String
  room   Room   @relation(fields: [roomId], references: [id], onDelete: Cascade)
  roomId String

  @@unique([userId, roomId])
  @@map("room_members")
}

model Message {
  id        String      @id @default(cuid())
  content   String
  type      MessageType @default(TEXT)
  fileUrl   String?
  fileName  String?
  fileSize  Int?
  isEdited  Boolean     @default(false)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  sender   User   @relation("MessageSender", fields: [senderId], references: [id])
  senderId String
  room     Room   @relation(fields: [roomId], references: [id], onDelete: Cascade)
  roomId   String

  replyTo   Message?  @relation("MessageReply", fields: [replyToId], references: [id])
  replyToId String?
  replies   Message[] @relation("MessageReply")

  @@map("messages")
  @@index([roomId, createdAt])
  @@index([senderId])
}

model Notification {
  id        String           @id @default(cuid())
  type      NotificationType
  title     String
  message   String
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  @@map("notifications")
}

enum UserStatus {
  ONLINE
  AWAY
  BUSY
  OFFLINE
}

enum RoomType {
  DIRECT
  GROUP
  CHANNEL
}

enum MemberRole {
  OWNER
  ADMIN
  MODERATOR
  MEMBER
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  SYSTEM
}

enum NotificationType {
  MESSAGE
  MENTION
  ROOM_INVITE
  SYSTEM
}